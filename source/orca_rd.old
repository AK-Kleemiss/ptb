!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! prepare ORCA AO data read
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      if(.not.rdq)then  ! normal calc or -qref
      Pref = 0
      Eref = 0
      inquire(file='orca.ref',exist=ex)
      if(.not.ex)then
        exref=.true.
        call rdstvint('orca.out',n,ndim,xyz,S,Fref,SS,T,Pref,eref,ekinref,enuc,dip_ref,pnt,alp_ref) ! full one
        write(*,*) 'STV read done.',ndim
        call reorder(ndim,n,at,S)
        call reorder(ndim,n,at,Pref)
        call reorder(ndim,n,at,Fref) 
        call reorder2(ndim,n,at)     ! MOs on cmo_ref (mocom)
!
!       just to speed up reading of orca stuff which is bottleneck in the fit
        write(*,*) 'converting reference data to binary.'
        open(unit=45,file='orca.ref',form='unformatted')
        write(45)S   
        write(45)Pref
        write(45)Fref
        write(45)dip_ref
        write(45)pnt   
        write(45)eref,ekinref
        if(alp_ref(1).gt.0) write(45)alp_ref
        close(45)
        open(unit=45,file='cmo.ref',form='unformatted')
        write(45)cmo_ref
        write(45)epsref
        close(45)
        write(*,*) 'DFT gap:',(epsref(ihomo+1)-epsref(ihomo))*27.212
        stop 'all done.'
      else
        exref=.true.
        write(*,*) 'reading reference data from binary <orac.ref>.'
        open(unit=45,file='orca.ref',form='unformatted')
        read (45)S   
        read (45)Pref
        read (45)Fref
        read (45)dip_ref
        read (45)pnt   
        read (45)eref,ekinref
        read (45,end=199)alp_ref
199     close(45)
!       call stint(n,ndim,at,xyz,rab,S,T,xnorm)     
!       call energy(ndim,T,Pref,ekinref) 
!       write(*,*) 'ekinref',ekinref
      endif
      if(eref.eq.0) goto 42
      if(wrref)then
         write(*,*)'ML populations (reference)'
         write(*,'('' PA setup with Mull-Loew partitioning '',f10.6,'' ...'')') mull_loew14
         call mlpop (n,ndim,Pref,S,q_ref,psh_ref) 
         do i=1,n    
         ns = bas_nsh(at(i))
         floats(1:ns)=psh_ref(1:ns,i)
         if(wrapo)call qshnorm(at(i),z(i),ns,floats)
         write(*,'(i3,5x,a2,f8.4,5x,10f7.3)') i,asym(at(i)),q_ref(i),psh_ref(1:ns,i)
         enddo
         call wiberg(n,ndim,at,rab,Pref,S,wbo_ref)
         call prwbo(n,at,wbo_ref)
         call prdipole(dip_ref) 
         if(alp_ref(1).gt.0) call prpolar (alp_ref) 
         open(unit=12,file='.QREF')  
         do i=1,n
         do j=1,bas_nsh(at(i))
            write(12,'(5D22.14)') psh_ref(j,i)
         enddo
         enddo
         do i=2,n
         do j=1,i-1 
            write(12,'(5D22.14)') wbo_ref(j,i)
         enddo
         enddo
         write(12,'(3D22.14)') pnt    (1:3) 
         write(12,'(3D22.14)') dip_ref(1:3) 
         write(12,'(2D22.14)') eref,ekinref
         if(alp_ref(1).gt.0) write(12,'(6D22.14)')alp_ref(1:6)
         close(12)
         goto 9999
      endif
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! -rdq fit case
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      else                        
      inquire(file='cmo.ref',exist=ex)
      if(ex)then
      open(unit=45,file='cmo.ref',form='unformatted')
      read(45)cmo_ref
      read(45)epsref
      close(45)
      else
      cmo_ref=-99d0
      endif
      wbo_ref=0
      inquire(file='.QREF',exist=ex)
      if(.not.ex)then
      psh_ref = 0
      q_ref   = 0
      dip_ref = 0
      alp_ref = -99
      else
      exref=.true.
      open(unit=12,file='.QREF')  
      do i=1,n
         q_ref(i)=0
         do j=1,bas_nsh(at(i))
            read(12,'(5D22.14)') psh_ref(j,i)
            q_ref(i)=q_ref(i)+psh_ref(j,i)
         enddo
      enddo
      do i=2,n
         do j=1,i-1 
            read(12,'(5D22.14)') wbo_ref(j,i)
            wbo_ref(i,j)=wbo_ref(j,i)
         enddo
      enddo
      read(12,'(3D22.14)') pnt    (1:3) 
      read(12,'(3D22.14)') dip_ref(1:3) 
      read(12,'(2D22.14)') eref,ekinref
      read(12,'(6D22.14)',end=299) alp_ref(1:6) 
299   close(12)
      endif
      endif

      if(rdref)then
        open(unit=45,file='orca.ref',form='unformatted')
        read (45)S   
        read (45)Pref
        read (45)Fref
        close(45)
      endif

