!! ---------------------------------------------------------------------------
!  guess shell populations from atomic charge and dpsh/dq derivatives
!! ---------------------------------------------------------------------------

subroutine guess_qsh(n,at,z,q,psh)
      use bascom
      use parcom
      implicit none
      integer n,at(n) 
      real*8  z(n),q(n),psh(10,n)

      integer i,j,ati,ns
      real*8  pshref(10),norm,fac(10)

      do i=1,n
         ati = at(i)
         ns  = bas_nsh(ati)
!        ref. neutral shell pop
         call shellocc_ref(ati,pshref)

!        norm=sum(shell_resp(1:ns,ati,2))
!        fac(1:ns)=shell_resp(1:ns,ati,2)/norm
!                                         "contains" a unit charge
         do j=1,ns
!           psh(j,i) = pshref(j)  - q(i) * dpshdq(j,ati)
!           psh(j,i) = pshref(j) - q(i) * fac(j)          
            psh(j,i) = pshref(j) * (z(i)-q(i))/z(i)       
         enddo

      enddo

end

!! ------------------------------------------------------------------------
!  dpsh/dq numerical derivatives to guess psh from atomic (EEQ) charge  
!  use .rundpdn (prep), .run_dpdn (DFT) and wr_dpsh_dn.f90 to generate data 
!  wB97x-3c values averaged over 10-20 molecules (closed-shell, no charge)
!  for each element
!! ------------------------------------------------------------------------

subroutine set_dpsh_dq
      use bascom, only: dpshdq
      implicit none
      integer i,j
      real*8 norm

      dpshdq = 0

      dpshdq( 1, 1)=  0.522235630998
      dpshdq( 2, 1)=  0.379352429551
      dpshdq( 3, 1)=  0.098411939450
      dpshdq( 1, 2)=  0.487754907247
      dpshdq( 2, 2)=  0.498917742497
      dpshdq( 3, 2)=  0.013327350256
      dpshdq( 1, 3)=  0.490956829004
      dpshdq( 2, 3)=  0.149676747095
      dpshdq( 3, 3)=  0.150668651008
      dpshdq( 4, 3)=  0.175403245917
      dpshdq( 5, 3)=  0.033294526976
      dpshdq( 1, 4)=  0.480668637284
      dpshdq( 2, 4)=  0.071699670485
      dpshdq( 3, 4)=  0.179134158890
      dpshdq( 4, 4)=  0.199270768099
      dpshdq( 5, 4)=  0.069226765240
      dpshdq( 1, 5)=  0.077239052728
      dpshdq( 2, 5)=  0.127811539764
      dpshdq( 3, 5)=  0.164535050942
      dpshdq( 4, 5)=  0.532534141403
      dpshdq( 5, 5)=  0.097880215163
      dpshdq( 1, 6)=  0.115353428135
      dpshdq( 2, 6)=  0.119878896001
      dpshdq( 3, 6)=  0.052397476839
      dpshdq( 4, 6)=  0.659218169982
      dpshdq( 5, 6)=  0.053152029043
      dpshdq( 1, 7)=  0.081985641677
      dpshdq( 2, 7)=  0.178925297777
      dpshdq( 3, 7)= -0.067668754065
      dpshdq( 4, 7)=  0.777642766929
      dpshdq( 5, 7)=  0.029115047682
      dpshdq( 1, 8)=  0.073979499579
      dpshdq( 2, 8)=  0.153914170840
      dpshdq( 3, 8)= -0.011641962450
      dpshdq( 4, 8)=  0.781744315164
      dpshdq( 5, 8)=  0.002003976868
      dpshdq( 1, 9)=  0.116952000623
      dpshdq( 2, 9)=  0.126645381102
      dpshdq( 3, 9)=  0.094095579457
      dpshdq( 4, 9)=  0.667071473195
      dpshdq( 5, 9)= -0.004764434377
      dpshdq( 1,10)=  0.164616262908
      dpshdq( 2,10)=  0.081484909937
      dpshdq( 3,10)=  0.399005394806
      dpshdq( 4,10)=  0.352135638259
      dpshdq( 5,10)=  0.002757794091
      dpshdq( 1,11)=  0.142461770070
      dpshdq( 2,11)=  0.056238707046
      dpshdq( 3,11)=  0.147809197036
      dpshdq( 4,11)=  0.477562055405
      dpshdq( 5,11)=  0.094213600405
      dpshdq( 6,11)=  0.081714670038
      dpshdq( 1,12)=  0.148988515622
      dpshdq( 2,12)=  0.063459766499
      dpshdq( 3,12)=  0.057884357744
      dpshdq( 4,12)=  0.616230619675
      dpshdq( 5,12)=  0.073387259401
      dpshdq( 6,12)=  0.040049481058
      dpshdq( 1,13)=  0.069689167499
      dpshdq( 2,13)=  0.104660927042
      dpshdq( 3,13)=  0.112285669832
      dpshdq( 4,13)=  0.633270094769
      dpshdq( 5,13)=  0.080094140859
      dpshdq( 1,14)=  0.093875183035
      dpshdq( 2,14)=  0.199909870257
      dpshdq( 3,14)=  0.047523457579
      dpshdq( 4,14)=  0.610488589496
      dpshdq( 5,14)=  0.048202899633
      dpshdq( 1,15)=  0.100600049464
      dpshdq( 2,15)=  0.196131795744
      dpshdq( 3,15)=  0.045224314780
      dpshdq( 4,15)=  0.617590920923
      dpshdq( 5,15)=  0.040452919089
      dpshdq( 1,16)=  0.112564293548
      dpshdq( 2,16)=  0.156519315432
      dpshdq( 3,16)= -0.078040608322
      dpshdq( 4,16)=  0.790965674154
      dpshdq( 5,16)=  0.017991325189
      dpshdq( 1,17)=  0.102471875839
      dpshdq( 2,17)=  0.114439778678
      dpshdq( 3,17)=  0.118122413494
      dpshdq( 4,17)=  0.671845693370
      dpshdq( 5,17)= -0.006879761381
      dpshdq( 1,18)=  0.154826168986
      dpshdq( 2,18)=  0.093834027977
      dpshdq( 3,18)=  0.401777150725
      dpshdq( 4,18)=  0.322607947826
      dpshdq( 5,18)=  0.026954704486
      dpshdq( 1,19)=  0.156451915558
      dpshdq( 2,19)=  0.061165856385
      dpshdq( 3,19)=  0.097446846998
      dpshdq( 4,19)=  0.538711754549
      dpshdq( 5,19)=  0.095082521872
      dpshdq( 6,19)=  0.051141104637
      dpshdq( 1,20)=  0.183408798484
      dpshdq( 2,20)=  0.015508815396
      dpshdq( 3,20)=  0.119000608323
      dpshdq( 4,20)=  0.547734649622
      dpshdq( 5,20)=  0.113236464357
      dpshdq( 6,20)=  0.021110663818
      dpshdq( 1,21)=  0.103187364183
      dpshdq( 2,21)=  0.083807918900
      dpshdq( 3,21)=  0.029909869755
      dpshdq( 4,21)=  0.569718095017
      dpshdq( 5,21)=  0.157457177674
      dpshdq( 6,21)= -0.096720746914
      dpshdq( 7,21)=  0.152640321386
      dpshdq( 1,22)=  0.083930363511
      dpshdq( 2,22)=  0.081481760740
      dpshdq( 3,22)= -0.075402372809
      dpshdq( 4,22)=  0.480923460185
      dpshdq( 5,22)=  0.065109930411
      dpshdq( 6,22)=  0.161847033460
      dpshdq( 7,22)=  0.202109824502
      dpshdq( 1,23)=  0.066137494240
      dpshdq( 2,23)=  0.093928104991
      dpshdq( 3,23)=  0.023305434684
      dpshdq( 4,23)=  0.483337243621
      dpshdq( 5,23)=  0.139236842593
      dpshdq( 6,23)=  0.073685388474
      dpshdq( 7,23)=  0.120369491398
      dpshdq( 1,24)=  0.066197975309
      dpshdq( 2,24)=  0.089678000580
      dpshdq( 3,24)=  0.035474391007
      dpshdq( 4,24)=  0.469992796439
      dpshdq( 5,24)=  0.119654733951
      dpshdq( 6,24)=  0.037547520792
      dpshdq( 7,24)=  0.181454581922
      dpshdq( 1,25)=  0.035531234368
      dpshdq( 2,25)=  0.029715102601
      dpshdq( 3,25)=  0.037886931801
      dpshdq( 4,25)=  0.172279823717
      dpshdq( 5,25)=  0.165365392175
      dpshdq( 6,25)=  0.467203356966
      dpshdq( 7,25)=  0.092018158372
      dpshdq( 1,26)=  0.024329770813
      dpshdq( 2,26)=  0.015424804750
      dpshdq( 3,26)=  0.022000625226
      dpshdq( 4,26)=  0.101908021097
      dpshdq( 5,26)=  0.068846606307
      dpshdq( 6,26)=  0.632230202055
      dpshdq( 7,26)=  0.135259969752
      dpshdq( 1,27)=  0.052861533056
      dpshdq( 2,27)=  0.031464876301
      dpshdq( 3,27)=  0.012007553165
      dpshdq( 4,27)=  0.248011260866
      dpshdq( 5,27)=  0.056463833552
      dpshdq( 6,27)=  0.497106520793
      dpshdq( 7,27)=  0.102084422266
      dpshdq( 1,28)=  0.080500730709
      dpshdq( 2,28)=  0.050374282513
      dpshdq( 3,28)=  0.197586561684
      dpshdq( 4,28)=  0.371423310391
      dpshdq( 5,28)=  0.090115488756
      dpshdq( 6,28)=  0.069694205515
      dpshdq( 7,28)=  0.140305420433
      dpshdq( 1,29)=  0.076562774889
      dpshdq( 2,29)=  0.048665115367
      dpshdq( 3,29)=  0.076585215678
      dpshdq( 4,29)=  0.352961140075
      dpshdq( 5,29)=  0.006240527941
      dpshdq( 6,29)=  0.008655406161
      dpshdq( 7,29)=  0.430329819889
      dpshdq( 1,30)=  0.055423443979
      dpshdq( 2,30)=  0.042315755670
      dpshdq( 3,30)=  0.093066077823
      dpshdq( 4,30)=  0.282237784031
      dpshdq( 5,30)=  0.064078571437
      dpshdq( 6,30)=  0.214068003131
      dpshdq( 7,30)=  0.248810363928
      dpshdq( 1,31)=  0.110452073590
      dpshdq( 2,31)=  0.067561471895
      dpshdq( 3,31)=  0.232608119549
      dpshdq( 4,31)=  0.446413169629
      dpshdq( 5,31)=  0.142965165337

      do i=1,31
      norm = 0
      do j=1,10
         norm = norm + dpshdq(j,i)
      enddo
      if(abs(1d0-norm).gt.1d-5) then
        write(*,*) i,'norm of dpsh/dq',norm
        stop 
      endif
      enddo

end
